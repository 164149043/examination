/**
 * @description è€ƒè¯•å¾—åˆ†å±•ç¤ºé¡µé¢
 * @author å¼ ä¸€ä¾æœ‰æŠŠè¶Šå¥³å‰‘
 * @date 2025-04-16
 */

<template>
	<view class="container">
		<view class="result-card" v-if="examRecord">
			<!-- å¾—åˆ†å±•ç¤º -->
			<view class="score-display">
				<view class="score-circle">
					<view class="score-inner">
						<text class="score-value">{{ examRecord.score }}</text>
						<text class="score-unit">åˆ†</text>
					</view>
				</view>
				
				<!-- æˆç»©è¯„ä»· -->
				<view class="score-evaluation">
					<text class="evaluation-text">{{ scoreEvaluation }}</text>
				</view>
			</view>
			
			<!-- æ’åä¿¡æ¯ -->
			<view class="rank-section">
				<view class="rank-item">
					<view class="rank-icon">ğŸ†</view>
					<view class="rank-content">
						<text class="rank-label">å½“å‰æ’å</text>
						<text class="rank-value">ç¬¬ {{ rank }} å</text>
					</view>
				</view>
				
				<view class="rank-item">
					<view class="rank-icon">ğŸ‘¥</view>
					<view class="rank-content">
						<text class="rank-label">å‚ä¸äººæ•°</text>
						<text class="rank-value">{{ totalParticipants }} äºº</text>
					</view>
				</view>
			</view>
			
			<!-- è€ƒè¯•ä¿¡æ¯ -->
			<view class="exam-info">
				<view class="section-title">
					<text>è€ƒè¯•è¯¦æƒ…</text>
				</view>
				
				<view class="info-container">
					<view class="info-item">
						<view class="info-icon">ğŸ“</view>
						<view class="info-content">
							<text class="info-label">è€ƒè¯•åç§°</text>
							<text class="info-value">{{ examRecord.title }}</text>
						</view>
					</view>
					
					<view class="info-item">
						<view class="info-icon">â±ï¸</view>
						<view class="info-content">
							<text class="info-label">è€ƒè¯•æ—¶é—´</text>
							<text class="info-value">{{ formatTime(examRecord.submitTime) }}</text>
						</view>
					</view>
					
					<view class="info-item">
						<view class="info-icon">ğŸ‘¤</view>
						<view class="info-content">
							<text class="info-label">è€ƒç”Ÿå§“å</text>
							<text class="info-value">{{ examRecord.name }}</text>
						</view>
					</view>
					
					<view class="info-item">
						<view class="info-icon">ğŸ¢</view>
						<view class="info-content">
							<text class="info-label">æ‰€å±éƒ¨é—¨</text>
							<text class="info-value">{{ examRecord.department }}</text>
						</view>
					</view>
				</view>
			</view>
		</view>
		
		<!-- æ“ä½œæŒ‰é’® -->
		<view class="action-buttons">
			<button class="btn primary" @click="goToHome">è¿”å›é¦–é¡µ</button>
			<button class="btn secondary" @click="retakeExam">é‡æ–°è€ƒè¯•</button>
		</view>
	</view>
</template>

<script>
	// å®šä¹‰è€ƒè¯•è®°å½•ç±»å‹
	interface ExamRecord {
		examId: number;
		title: string;
		name: string;
		department: string;
		score: number;
		submitTime: number;
	}
	
	export default {
		data() {
			return {
				examRecord: null as ExamRecord | null,
				rank: 0,
				totalParticipants: 0
			}
		},
		computed: {
			// æ ¹æ®åˆ†æ•°ç»™å‡ºè¯„ä»·
			scoreEvaluation(): string {
				if (!this.examRecord) return ''
				
				const score = this.examRecord.score
				if (score >= 90) return 'ä¼˜ç§€'
				if (score >= 80) return 'è‰¯å¥½'
				if (score >= 70) return 'ä¸­ç­‰'
				if (score >= 60) return 'åŠæ ¼'
				return 'éœ€è¦åŠ æ²¹'
			}
		},
		onLoad(options) {
			// è·å–ç”¨æˆ·ä¿¡æ¯
			const userInfo = uni.getStorageSync('userInfo') || {}
			
			// è·å–è€ƒè¯•è®°å½•
			const examRecords = uni.getStorageSync('examRecords') || []
			if (examRecords.length > 0) {
				// æŸ¥æ‰¾å½“å‰ç”¨æˆ·çš„è€ƒè¯•è®°å½•ï¼ˆä½¿ç”¨ä¼ å…¥çš„å¾—åˆ†å‚æ•°ï¼‰
				if (options.score) {
					// æŒ‰æ—¶é—´å€’åºæ’åˆ—çš„æ‰€æœ‰è®°å½•
					const sortedByTime = [...examRecords].sort((a, b) => b.submitTime - a.submitTime)
					
					// æŸ¥æ‰¾å½“å‰ç”¨æˆ·æœ€æ–°çš„è€ƒè¯•è®°å½•
					this.examRecord = sortedByTime.find(record => 
						record.name === userInfo.name && 
						record.department === userInfo.department &&
						record.score == options.score
					) as ExamRecord
				}
				
				// å¦‚æœæ²¡æ‰¾åˆ°ï¼Œä½¿ç”¨æœ€æ–°çš„è®°å½•ï¼ˆå…¼å®¹æ—§æ•°æ®ï¼‰
				if (!this.examRecord) {
					this.examRecord = examRecords[examRecords.length - 1] as ExamRecord
				}
				
				// è®¡ç®—æ’å
				if (this.examRecord) {
					// è·å–æ‰€æœ‰ä¸é‡å¤çš„è®°å½•ï¼ˆæŒ‰å§“åå’Œéƒ¨é—¨å»é‡ï¼‰
					const recordMap = new Map()
					examRecords.forEach(record => {
						const key = `${record.name}-${record.department}`
						if (!recordMap.has(key) || record.submitTime > recordMap.get(key).submitTime) {
							recordMap.set(key, record)
						}
					})
					const uniqueRecords = Array.from(recordMap.values())
					
					// æŒ‰åˆ†æ•°æ’åºè®¡ç®—å½“å‰ç”¨æˆ·çš„æ’å
					const sortedRecords = [...uniqueRecords].sort((a, b) => b.score - a.score)
					this.rank = sortedRecords.findIndex(record => 
						record.name === this.examRecord!.name && 
						record.department === this.examRecord!.department
					) + 1
					
					this.totalParticipants = uniqueRecords.length
				}
			} else {
				uni.showToast({
					title: 'æœªæ‰¾åˆ°è€ƒè¯•è®°å½•',
					icon: 'none'
				})
				this.goToHome()
			}
		},
		methods: {
			formatTime(timestamp: number): string {
				const date = new Date(timestamp)
				const year = date.getFullYear()
				const month = (date.getMonth() + 1).toString().padStart(2, '0')
				const day = date.getDate().toString().padStart(2, '0')
				const hour = date.getHours().toString().padStart(2, '0')
				const minute = date.getMinutes().toString().padStart(2, '0')
				return `${year}-${month}-${day} ${hour}:${minute}`
			},
			goToHome() {
				uni.reLaunch({
					url: '/pages/index/index'
				})
			},
			retakeExam() {
				// æ¸…é™¤å½“å‰è€ƒè¯•ä¿¡æ¯
				uni.removeStorageSync('currentExam')
				// ç›´æ¥å»é¦–é¡µåˆ›å»ºæ–°è€ƒè¯•
				uni.reLaunch({
					url: '/pages/index/index'
				})
			}
		}
	}
</script>

<style>
	.container {
		min-height: 100vh;
		background-color: #f5f5f5;
		padding: 40rpx;
	}
	
	.result-card {
		background-color: #fff;
		border-radius: 20rpx;
		overflow: hidden;
		box-shadow: 0 4rpx 20rpx rgba(0, 0, 0, 0.1);
	}
	
	/* åˆ†æ•°å±•ç¤ºæ ·å¼ */
	.score-display {
		padding: 60rpx 40rpx;
		display: flex;
		flex-direction: column;
		align-items: center;
		background: linear-gradient(135deg, #1E90FF, #6495ED);
		position: relative;
	}
	
	.score-circle {
		width: 200rpx;
		height: 200rpx;
		border-radius: 50%;
		background-color: rgba(255, 255, 255, 0.2);
		display: flex;
		justify-content: center;
		align-items: center;
		margin-bottom: 30rpx;
		animation: pulse 2s infinite;
	}
	
	@keyframes pulse {
		0% {
			transform: scale(1);
			box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.4);
		}
		70% {
			transform: scale(1.05);
			box-shadow: 0 0 0 20rpx rgba(255, 255, 255, 0);
		}
		100% {
			transform: scale(1);
		}
	}
	
	.score-inner {
		width: 180rpx;
		height: 180rpx;
		border-radius: 50%;
		background-color: white;
		display: flex;
		flex-direction: column;
		justify-content: center;
		align-items: center;
	}
	
	.score-value {
		font-size: 80rpx;
		color: #1E90FF;
		font-weight: bold;
		line-height: 1;
	}
	
	.score-unit {
		font-size: 32rpx;
		color: #1E90FF;
		margin-top: 5rpx;
	}
	
	.score-evaluation {
		background-color: rgba(255, 255, 255, 0.2);
		padding: 10rpx 40rpx;
		border-radius: 30rpx;
		margin-top: 20rpx;
	}
	
	.evaluation-text {
		font-size: 32rpx;
		color: #fff;
		font-weight: bold;
	}
	
	/* æ’åä¿¡æ¯æ ·å¼ */
	.rank-section {
		display: flex;
		padding: 40rpx;
		border-bottom: 2rpx solid #f0f0f0;
	}
	
	.rank-item {
		flex: 1;
		display: flex;
		align-items: center;
		padding: 0 20rpx;
	}
	
	.rank-item:first-child {
		border-right: 2rpx solid #f0f0f0;
	}
	
	.rank-icon {
		font-size: 48rpx;
		margin-right: 20rpx;
	}
	
	.rank-content {
		display: flex;
		flex-direction: column;
	}
	
	.rank-label {
		font-size: 26rpx;
		color: #999;
		margin-bottom: 10rpx;
	}
	
	.rank-value {
		font-size: 36rpx;
		color: #333;
		font-weight: bold;
	}
	
	/* è€ƒè¯•ä¿¡æ¯æ ·å¼ */
	.exam-info {
		padding: 40rpx;
	}
	
	.section-title {
		font-size: 30rpx;
		color: #333;
		font-weight: bold;
		margin-bottom: 30rpx;
		position: relative;
		padding-left: 20rpx;
	}
	
	.section-title:before {
		content: '';
		position: absolute;
		left: 0;
		top: 50%;
		transform: translateY(-50%);
		width: 8rpx;
		height: 30rpx;
		background-color: #1E90FF;
		border-radius: 4rpx;
	}
	
	.info-container {
		background-color: #f9f9f9;
		border-radius: 16rpx;
		padding: 20rpx;
	}
	
	.info-item {
		display: flex;
		align-items: center;
		padding: 20rpx 10rpx;
		border-bottom: 2rpx solid #f0f0f0;
	}
	
	.info-item:last-child {
		border-bottom: none;
	}
	
	.info-icon {
		font-size: 40rpx;
		width: 80rpx;
		text-align: center;
	}
	
	.info-content {
		flex: 1;
		margin-left: 20rpx;
	}
	
	.info-label {
		font-size: 26rpx;
		color: #999;
		margin-bottom: 6rpx;
		display: block;
	}
	
	.info-value {
		font-size: 30rpx;
		color: #333;
	}
	
	/* æ“ä½œæŒ‰é’®æ ·å¼ */
	.action-buttons {
		margin-top: 40rpx;
		display: flex;
		justify-content: space-between;
	}
	
	.btn {
		flex: 1;
		height: 88rpx;
		line-height: 88rpx;
		text-align: center;
		border-radius: 44rpx;
		font-size: 32rpx;
		margin: 0 10rpx;
	}
	
	.btn.primary {
		background-color: #1E90FF;
		color: #fff;
	}
	
	.btn.secondary {
		background-color: #fff;
		color: #1E90FF;
		border: 2rpx solid #1E90FF;
	}
</style> 